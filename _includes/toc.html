<!-- Foldable Table of Contents -->
<div class="outline">
    <div class="outline-header">Table of Contents</div>
    <!-- The content can be generated by JavaScript or manually structured -->
    <ul>
        {% if page.url contains 'e7.html' %}
            <!-- Manually structured TOC for e7.html -->
            <li>
                <span class="toc-toggle"><i class="fas fa-chevron-down"></i></span>
                <a href="#locks-and-unlocks">Locks and Unlocks</a>
            </li>
            <li>
                <span class="toc-toggle"><i class="fas fa-chevron-down"></i></span>
                <a href="#octant-aggregates">Octant Aggregates</a>
                <ul class="toc-submenu">
                    <li><a href="#amounts" class="h2-link">Amounts (ETH)</a></li>
                    <li><a href="#users" class="h2-link">Users (addresses)</a></li>
                </ul>
            </li>
            <li>
                <span class="toc-toggle"><i class="fas fa-chevron-down"></i></span>
                <a href="#users-section">Users</a>
                <ul class="toc-submenu">
                    <li><a href="#epoch-progress" class="h2-link">(1.1) Epoch Progress</a></li>
                    <li><a href="#daily-new-users" class="h2-link">(1.2) Daily New Users</a></li>
                    <li><a href="#epoch-turnout" class="h2-link">(1.3) Epoch Turnout</a></li>
                    <li><a href="#allocation-changes" class="h2-link">(1.4) Allocation Changes</a></li>
                    <li><a href="#distribution-of-donations" class="h2-link">(1.5) Distribution of Donations</a></li>
                    <li><a href="#user-types" class="h2-link">(1.6) User Types</a></li>
                    <li><a href="#projects-supported" class="h2-link">(1.7) Projects Supported</a></li>
                </ul>
            </li>
            <li>
                <span class="toc-toggle"><i class="fas fa-chevron-down"></i></span>
                <a href="#funding-distribution">Funding Distribution</a>
                <ul class="toc-submenu">
                    <li><a href="#qf-vs-linear" class="h2-link">(2.1) QF vs Linear Distribution</a></li>
                    <li><a href="#correlations" class="h2-link">(2.2) Correlations</a></li>
                    <li><a href="#voting-power" class="h2-link">(2.3) Voting Power</a></li>
                    <li><a href="#proper-qf" class="h2-link">(2.4) Proper QF</a></li>
                </ul>
            </li>
            <li>
                <span class="toc-toggle"><i class="fas fa-chevron-down"></i></span>
                <a href="#user-flows">User Flows</a>
                <ul class="toc-submenu">
                    <li><a href="#user-history" class="h2-link">(3.1) User History</a></li>
                    <li><a href="#transitions" class="h2-link">(3.2) Transitions of Allocators</a></li>
                </ul>
            </li>
        {% elsif page.url contains 'e6.html' %}
            <!-- Similar structure for e6.html - can be added later -->
        {% elsif page.url contains 'e5.html' %}
            <!-- Similar structure for e5.html - can be added later -->
        {% else %}
            <!-- Dynamic generation will be used for other pages -->
        {% endif %}
    </ul>
</div>

<!-- Mobile menu toggle for the TOC -->
<div class="menu-toggle" id="menu-toggle">
    <i class="fas fa-bars"></i>
</div>

<style>
    /* Additional TOC control styles */
    .outline-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }
    
    .outline-control {
        color: var(--primary-color);
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        background: var(--gray-100);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: var(--transition);
    }
    
    .outline-control:hover {
        background: var(--gray-200);
    }
    
    .outline-control i {
        margin-right: 4px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add expand/collapse all controls
        const tocHeader = document.querySelector('.outline-header');
        
        if (tocHeader) {
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'outline-controls';
            
            const expandAll = document.createElement('span');
            expandAll.className = 'outline-control';
            expandAll.innerHTML = '<i class="fas fa-plus-square"></i> Expand All';
            
            const collapseAll = document.createElement('span');
            collapseAll.className = 'outline-control';
            collapseAll.innerHTML = '<i class="fas fa-minus-square"></i> Collapse All';
            
            controlsDiv.appendChild(expandAll);
            controlsDiv.appendChild(collapseAll);
            
            tocHeader.insertAdjacentElement('afterend', controlsDiv);
            
            // Add event listeners
            expandAll.addEventListener('click', function() {
                document.querySelectorAll('.toc-submenu').forEach(submenu => {
                    submenu.classList.remove('toc-collapsed');
                });
                document.querySelectorAll('.toc-toggle i').forEach(icon => {
                    icon.className = 'fas fa-chevron-down';
                });
            });
            
            collapseAll.addEventListener('click', function() {
                document.querySelectorAll('.toc-submenu').forEach(submenu => {
                    submenu.classList.add('toc-collapsed');
                });
                document.querySelectorAll('.toc-toggle i').forEach(icon => {
                    icon.className = 'fas fa-chevron-right';
                });
            });
        }
        
        // Initialize TOC with all items collapsed except the active one
        function initializeCollapsedTOC() {
            // Get the current hash from URL
            const currentHash = window.location.hash;
            
            // Collapse all submenus first
            document.querySelectorAll('.toc-submenu').forEach(submenu => {
                submenu.classList.add('toc-collapsed');
            });
            
            document.querySelectorAll('.toc-toggle i').forEach(icon => {
                icon.className = 'fas fa-chevron-right';
            });
            
            // If there's a hash in the URL, expand the relevant section
            if (currentHash) {
                // Find which section this hash belongs to
                let activeSection = null;
                document.querySelectorAll('.outline a').forEach(link => {
                    if (link.getAttribute('href') === currentHash) {
                        // If it's a subsection, find its parent
                        if (link.classList.contains('h2-link')) {
                            activeSection = link.closest('ul').closest('li');
                        } else {
                            activeSection = link.closest('li');
                        }
                    }
                });
                
                // Expand this section
                if (activeSection) {
                    const submenu = activeSection.querySelector('.toc-submenu');
                    const toggleIcon = activeSection.querySelector('.toc-toggle i');
                    
                    if (submenu) {
                        submenu.classList.remove('toc-collapsed');
                    }
                    
                    if (toggleIcon) {
                        toggleIcon.className = 'fas fa-chevron-down';
                    }
                }
            } else {
                // If no hash, expand the first section by default
                const firstSubmenu = document.querySelector('.outline > ul > li:first-child .toc-submenu');
                const firstToggle = document.querySelector('.outline > ul > li:first-child .toc-toggle i');
                
                if (firstSubmenu) {
                    firstSubmenu.classList.remove('toc-collapsed');
                }
                
                if (firstToggle) {
                    firstToggle.className = 'fas fa-chevron-down';
                }
            }
        }
        
        // Run initialization
        initializeCollapsedTOC();
        
        // Also update when hash changes
        window.addEventListener('hashchange', initializeCollapsedTOC);
    });
</script> 